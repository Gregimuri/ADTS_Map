<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта торговых точек ADTS</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Стили -->
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Анимации для уведомлений */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Стили для выпадающих списков с цветами статусов */
        .status-option {
            padding-left: 5px;
        }
        
        .status-color-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* Стили для улучшенной легенды */
        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .legend-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(3px);
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid white;
            margin-right: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .legend-count {
            font-size: 11px;
            color: #95a5a6;
            background: rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }
        
        /* Стили для улучшенных карточек статистики */
        .stat-card .stat-icon {
            position: relative;
        }
        
        .stat-card .stat-icon::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            z-index: -1;
        }
        
        /* Подсказки для фильтров */
        .filter-hint {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Сайдбар -->
        <div class="sidebar">
            <!-- Заголовок -->
            <div class="header">
                <h1><i class="fas fa-map-marked-alt"></i> Карта ТТ ADTS</h1>
                <div class="status" id="status">
                    <i class="fas fa-sync-alt fa-spin"></i> Загрузка...
                </div>
                <div class="hint" style="margin-top: 8px;">
                    <i class="fas fa-info-circle"></i>
                    <span>Система мониторинга точек ADTS</span>
                </div>
            </div>
            
            <!-- Статистика -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #3498db;">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="total-points">0</div>
                        <div class="stat-label">Всего точек</div>
                        <div class="filter-hint">
                            <i class="fas fa-filter" style="font-size: 10px;"></i>
                            <span id="total-hint">Загружается...</span>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #2ecc71;">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="shown-points">0</div>
                        <div class="stat-label">Показано</div>
                        <div class="hint" id="shown-percentage">0%</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f39c12;">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="accuracy-stats">-</div>
                        <div class="stat-label">Точность</div>
                        <div class="hint" id="accuracy-hint">Точные/Приблизительные</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #9b59b6;">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="last-update">-:-</div>
                        <div class="stat-label">Обновлено</div>
                        <div class="hint" id="update-timer">--:--</div>
                    </div>
                </div>
            </div>
            
            <!-- Управление -->
            <div class="controls">
                <button class="btn btn-primary" onclick="loadData()" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Обновить данные
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-filter"></i> Сбросить фильтры
                </button>
            </div>
            
            <!-- Поиск -->
            <div class="search-sidebar" style="padding: 0 20px 15px;">
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="search-sidebar" placeholder="Поиск по названию, адресу, региону..." 
                           style="flex: 1; padding: 10px; border: 1px solid #4a6572; border-radius: 6px; background: #34495e; color: white;"
                           title="Введите текст для поиска. Нажмите Enter для быстрого поиска.">
                    <button onclick="searchPointsSidebar()" style="padding: 10px 15px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;"
                            title="Выполнить поиск">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="hint" style="margin-top: 5px;">
                    <i class="fas fa-lightbulb"></i>
                    <span>Используйте Ctrl+клик для множественного выбора в фильтрах</span>
                </div>
            </div>
            
            <!-- Фильтры -->
            <div class="filters">
                <h3><i class="fas fa-filter"></i> Фильтры</h3>
                
                <!-- Новый фильтр: Листы -->
                <div class="filter-group">
                    <label for="filter-sheets">Листы (проекты):</label>
                    <select id="filter-sheets" multiple class="filter-select" title="Удерживайте Ctrl для выбора нескольких листов">
                        <option value="">Все листы</option>
                    </select>
                    <div class="filter-hint" id="sheets-count">0 листов</div>
                    <div class="hint" style="margin-top: 3px; font-size: 11px;">
                        <i class="fas fa-info-circle"></i>
                        <span>Каждый лист = отдельный проект</span>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label for="filter-project">Проект:</label>
                    <select id="filter-project" multiple class="filter-select" title="Удерживайте Ctrl для выбора нескольких проектов">
                        <option value="">Все проекты</option>
                    </select>
                    <div class="filter-hint" id="project-count">0 проектов</div>
                </div>
                
                <div class="filter-group">
                    <label for="filter-region">Регион:</label>
                    <select id="filter-region" multiple class="filter-select" title="Удерживайте Ctrl для выбора нескольких регионов">
                        <option value="">Все регионы</option>
                    </select>
                    <div class="filter-hint" id="region-count">0 регионов</div>
                </div>
                
                <div class="filter-group">
                    <label for="filter-status">Статус монтажа:</label>
                    <select id="filter-status" multiple class="filter-select" title="Удерживайте Ctrl для выбора нескольких статусов">
                        <option value="">Все статусы</option>
                    </select>
                    <div class="filter-hint" id="status-count">0 статусов</div>
                </div>
                
                <div class="filter-group">
                    <label for="filter-manager">Менеджер:</label>
                    <select id="filter-manager" multiple class="filter-select" title="Удерживайте Ctrl для выбора нескольких менеджеров">
                        <option value="">Все менеджеры</option>
                    </select>
                    <div class="filter-hint" id="manager-count">0 менеджеров</div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="applyFilters()" style="flex: 1;" id="apply-filters-btn">
                        <i class="fas fa-check"></i> Применить
                    </button>
                    <button class="btn btn-secondary" onclick="clearFilters()" style="flex: 1;">
                        <i class="fas fa-times"></i> Сбросить
                    </button>
                </div>
            </div>
            
            <!-- Информация о точке -->
            <div class="point-info" id="point-info" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4><i class="fas fa-info-circle"></i> Информация о точке</h4>
                    <button onclick="document.getElementById('point-info').style.display='none'" 
                            style="background: none; border: none; color: #95a5a6; cursor: pointer; font-size: 16px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;"
                            title="Закрыть информацию"
                            onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'"
                            onmouseout="this.style.backgroundColor='transparent'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="point-details"></div>
            </div>
            
            <!-- Легенда точности -->
            <div class="legend-mini" style="padding: 15px; background: rgba(0,0,0,0.1); margin: 20px; border-radius: 8px;">
                <h5 style="color: white; margin-bottom: 10px; font-size: 14px;">
                    <i class="fas fa-map-pin"></i> Легенда координат
                </h5>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 14px; height: 14px; background: #2ecc71; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                        <span style="font-size: 12px; color: #ecf0f1;">Точные координаты</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 14px; height: 14px; background: #f39c12; border-radius: 50%; border: 2px solid white; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                            <div style="position: absolute; top: -3px; right: -3px; width: 6px; height: 6px; background: #f39c12; border-radius: 50%; border: 1px solid white;"></div>
                        </div>
                        <span style="font-size: 12px; color: #ecf0f1;">Приблизительные</span>
                    </div>
                </div>
            </div>
            
            <!-- Легенда статусов ADTS -->
            <div class="legend-mini" style="padding: 15px; background: rgba(0,0,0,0.1); margin: 20px; border-radius: 8px;">
                <h5 style="color: white; margin-bottom: 15px; font-size: 14px;">
                    <i class="fas fa-palette"></i> Цвета статусов ADTS
                </h5>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="status-indicator" style="background: #2ecc71;"></div>
                            <span style="font-size: 12px; color: #ecf0f1;">Выполнен</span>
                        </div>
                        <span id="count-completed" class="legend-count">0</span>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="status-indicator" style="background: #e74c3c;"></div>
                            <span style="font-size: 12px; color: #ecf0f1;">Нет оборудования</span>
                        </div>
                        <span id="count-no-equipment" class="legend-count">0</span>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="status-indicator" style="background: #3498db;"></div>
                            <span style="font-size: 12px; color: #ecf0f1;">В очереди</span>
                        </div>
                        <span id="count-queue" class="legend-count">0</span>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="status-indicator" style="background: #f1c40f;"></div>
                            <span style="font-size: 12px; color: #ecf0f1;">Первичный</span>
                        </div>
                        <span id="count-primary" class="legend-count">0</span>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="status-indicator" style="background: #9b59b6;"></div>
                            <span style="font-size: 12px; color: #ecf0f1;">Финальный</span>
                        </div>
                        <span id="count-final" class="legend-count">0</span>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="status-indicator" style="background: #95a5a6;"></div>
                            <span style="font-size: 12px; color: #ecf0f1;">Доработка</span>
                        </div>
                        <span id="count-rework" class="legend-count">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Карта -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Поиск на карте -->
            <div class="search-box">
                <input type="text" id="search" placeholder="Поиск по названию, адресу, региону..." 
                       title="Введите текст для поиска. Нажмите Enter для быстрого поиска.">
                <button onclick="searchPoints()" title="Выполнить поиск">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <!-- Легенда статусов -->
            <div class="legend">
                <div id="legend"></div>
            </div>
            
            <!-- Кнопка централизации карты -->
            <button onclick="centerMap()" style="position: absolute; bottom: 80px; right: 20px; z-index: 1000; background: white; color: #2c3e50; border: none; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.3s;"
                    title="Центрировать карту на отфильтрованных точках"
                    onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.2)'">
                <i class="fas fa-crosshairs"></i>
            </button>
        </div>
    </div>

    <!-- Модальное окно -->
    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <div id="modal-message"></div>
            <button class="btn btn-primary" onclick="closeModal()" style="margin-top: 20px;">OK</button>
        </div>
    </div>

    <!-- Библиотеки -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Конфигурация -->
    <script src="config.js"></script>
    
    <!-- Приложение -->
    <script src="app.js"></script>
    
    <!-- Дополнительные функции -->
    <script>
        // Функция для быстрого фильтра по статусу
        function filterByStatus(status) {
            const statusSelect = document.getElementById('filter-status');
            if (!statusSelect) return;
            
            // Сбрасываем все выборы
            Array.from(statusSelect.options).forEach(option => {
                option.selected = false;
            });
            
            // Выбираем нужный статус
            Array.from(statusSelect.options).forEach(option => {
                if (option.value === status) {
                    option.selected = true;
                }
            });
            
            if (typeof applyFilters === 'function') {
                applyFilters();
            }
            showNotification(`Фильтр по статусу: ${status}`, 'success');
        }
        
        // Функция поиска из сайдбара
        function searchPointsSidebar() {
            const searchInput = document.getElementById('search-sidebar');
            const searchMapInput = document.getElementById('search');
            
            if (!searchInput || !searchMapInput) return;
            
            // Копируем значение в поле поиска на карте
            searchMapInput.value = searchInput.value;
            
            if (typeof searchPoints === 'function') {
                searchPoints();
            }
        }
        
        // Функция центрирования карты
        function centerMap() {
            if (typeof centerMapOnFilteredPoints === 'function') {
                centerMapOnFilteredPoints();
            } else {
                // Фолбэк функция
                const filteredPoints = window.filterPoints ? window.filterPoints() : [];
                if (filteredPoints.length > 0) {
                    const bounds = L.latLngBounds(
                        filteredPoints
                            .filter(p => p.lat && p.lng)
                            .map(p => [p.lat, p.lng])
                    );
                    
                    if (bounds.isValid()) {
                        window.map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
                        showNotification('Карта центрирована на отфильтрованных точках', 'info');
                    }
                } else {
                    showNotification('Нет точек для центрирования', 'warning');
                }
            }
        }
        
        // Автозапуск поиска при нажатии Enter в сайдбаре
        document.getElementById('search-sidebar').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPointsSidebar();
            }
        });
        
        // Автозапуск поиска при нажатии Enter на карте
        document.getElementById('search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (typeof searchPoints === 'function') {
                    searchPoints();
                }
            }
        });
        
        // Обновляем легенду при изменении фильтров
        document.getElementById('filter-status').addEventListener('change', function() {
            if (typeof updateLegendFromApp === 'function') {
                updateLegendFromApp();
            }
            if (typeof updateFilterCounts === 'function') {
                updateFilterCounts();
            }
        });
        
        document.getElementById('filter-region').addEventListener('change', function() {
            if (typeof updateLegendFromApp === 'function') {
                updateLegendFromApp();
            }
            if (typeof updateFilterCounts === 'function') {
                updateFilterCounts();
            }
        });
        
        document.getElementById('filter-project').addEventListener('change', function() {
            if (typeof updateLegendFromApp === 'function') {
                updateLegendFromApp();
            }
            if (typeof updateFilterCounts === 'function') {
                updateFilterCounts();
            }
        });
        
        document.getElementById('filter-manager').addEventListener('change', function() {
            if (typeof updateLegendFromApp === 'function') {
                updateLegendFromApp();
            }
            if (typeof updateFilterCounts === 'function') {
                updateFilterCounts();
            }
        });
        
        document.getElementById('filter-sheets').addEventListener('change', function() {
            if (typeof updateLegendFromApp === 'function') {
                updateLegendFromApp();
            }
            if (typeof updateFilterCounts === 'function') {
                updateFilterCounts();
            }
        });
        
        // Функция для обновления счетчиков фильтров
        function updateFilterCounts() {
            const updateCount = (selectId, countElementId) => {
                const select = document.getElementById(selectId);
                const countElement = document.getElementById(countElementId);
                if (select && countElement) {
                    const selectedCount = Array.from(select.selectedOptions).filter(opt => opt.value !== '').length;
                    const totalCount = select.options.length - 1; // исключаем "Все"
                    
                    if (selectedCount === 0) {
                        countElement.textContent = `Все (${totalCount})`;
                    } else {
                        countElement.textContent = `${selectedCount} из ${totalCount} выбрано`;
                    }
                }
            };
            
            updateCount('filter-sheets', 'sheets-count');
            updateCount('filter-project', 'project-count');
            updateCount('filter-region', 'region-count');
            updateCount('filter-status', 'status-count');
            updateCount('filter-manager', 'manager-count');
        }
        
        // Инициализация счетчиков фильтров при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateFilterCounts, 1000);
        });
        
        function updateLegendFromApp() {
            if (typeof updateLegend === 'function') {
                updateLegend();
            }
        }
        
        // Добавляем тултипы для кнопок
        document.addEventListener('DOMContentLoaded', function() {
            // Добавляем тултипы для кнопок управления
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.title = "Обновить данные из Google Таблицы";
            }
            
            const applyBtn = document.getElementById('apply-filters-btn');
            if (applyBtn) {
                applyBtn.title = "Применить выбранные фильтры";
            }
        });
        
        // Функция для выбора всех листов
        function selectAllSheets() {
            if (typeof window.selectAllSheets === 'function') {
                window.selectAllSheets();
            }
        }
    </script>
</body>
</html>
